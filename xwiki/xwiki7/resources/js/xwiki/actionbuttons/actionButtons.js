var XWiki=(function(d){var c=d.actionButtons=d.actionButtons||{};c.EditActions=Class.create({initialize:function(){this.addListeners();this.addShortcuts();this.addValidators()},addListeners:function(){$$("input[name=action_cancel]").each(function(e){e.observe("click",this.onCancel.bindAsEventListener(this))}.bind(this));$$("input[name=action_preview]").each(function(e){e.observe("click",this.onSubmit.bindAsEventListener(this,"preview"))}.bind(this));$$("input[name=action_save]").each(function(e){e.observe("click",this.onSubmit.bindAsEventListener(this,"save"))}.bind(this));$$("input[name=action_saveandcontinue]").each(function(e){e.observe("click",this.onSubmit.bindAsEventListener(this,"save",true))}.bind(this))},addShortcuts:function(){var e={action_cancel:"$services.localization.render('core.shortcuts.edit.cancel')",action_preview:"$services.localization.render('core.shortcuts.edit.preview')",action_edit:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_inline:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_save:"$services.localization.render('core.shortcuts.edit.saveandview')",action_propupdate:"$services.localization.render('core.shortcuts.edit.saveandview')",action_saveandcontinue:"$services.localization.render('core.shortcuts.edit.saveandcontinue')"};for(var f in e){var g=$$("input[name="+f+"]");if(g.size()>0){shortcut.add(e[f],function(){this.click()}.bind(g.first()),{propagate:false})}}},validators:new Array(),addValidators:function(){var e=$("body").select("input.required");for(var h=0;h<e.length;h++){var f=e[h];var g=new LiveValidation(f,{validMessage:""});g.add(Validate.Presence,{failureMessage:"$services.localization.render('core.validation.required.message')"});g.validate();this.validators.push(g)}},validateForm:function(g){for(var f=0;f<this.validators.length;f++){if(!this.validators[f].validate()){return false}}var h=g.comment;if(h&&($xwiki.isEditCommentSuggested()||$xwiki.isEditCommentMandatory())){while(h.value==""){var e=prompt("$services.localization.render('core.comment.prompt')","");if(e===null){return false}h.value=e;if(!$xwiki.isEditCommentMandatory()){break}}}return true},onCancel:function(g){g.stop();this.notify(g,"cancel");var f=g.element().form.action;if(typeof f!="string"){f=g.element().form.attributes.getNamedItem("action");if(f){f=f.nodeValue}else{f=window.self.location.href}}var i=f.split("#",2);var k=(i.length==2)?i[1]:"";f=i[0];if(f.indexOf("?")==-1){f+="?"}var j="&action_cancel=true";var h=g.element().form.elements.xredirect;var e=h?"&xredirect="+escape(h.value):"";d.EditLock&&d.EditLock.setLocked(false);window.location=f+j+e+k},onSubmit:function(g,h,f){var e="before"+h.substr(0,1).toUpperCase()+h.substr(1);if(this.notify(g,e,{"continue":f})){if(this.validateForm(g.element().form)){this.notify(g,h,{"continue":f})}else{g.stop()}}},notify:function(e,f,g){document.fire("xwiki:actions:"+f,Object.extend({originalEvent:e,form:e.element().form},g||{}));if(e.stopped){e.stop()}return !e.stopped}});c.AjaxSaveAndContinue=Class.create({initialize:function(){this.createMessages();this.addListeners()},createMessages:function(){this.savingBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.inprogress'))","inprogress",{inactive:true});this.savedBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.done'))","done",{inactive:true});this.failedBox=new d.widgets.Notification('$escapetool.javascript($services.localization.render("core.editors.saveandcontinue.notification.error", ["<span id=""ajaxRequestFailureReason""/>"]))',"error",{inactive:true});this.progressMessageTemplate="$escapetool.javascript($services.localization.render('core.editors.savewithprogress.notification'))";this.progressBox=new d.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__","0"),"inprogress",{inactive:true})},addListeners:function(){document.observe("xwiki:actions:save",this.onSave.bindAsEventListener(this))},onSave:function(h){if(h.stopped){return}var k=h.memo["continue"];this.form=$(h.memo.form);this.savedBox.hide();this.failedBox.hide();var e=(this.form.template&&this.form.template.value);if(!e&&(!k||$("body").hasClassName("previewbody"))){return}var g=(this.form.action.indexOf("/preview/")==-1);var i=(this.form.async&&this.form.async.value==="true");if(!i||g){if(!k){return}e=false}if(typeof(h.memo.originalEvent)!="undefined"){h.memo.originalEvent.stop()}if(e){this.progressBox.show()}else{if(k){this.savingBox.show()}}var f="action_save";if(k){f="action_saveandcontinue"}var j=new Hash(this.form.serialize({hash:true,submit:f}));if(k){j.set("minorEdit","1")}if(!Prototype.Browser.Opera){j.set("ajax","true")}new Ajax.Request(this.form.action,{method:"post",parameters:j.toQueryString(),onSuccess:this.onSuccess.bindAsEventListener(this,k,e),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})},on1223:function(e){e.request.options.onSuccess(e)},on0:function(e){e.request.options.onFailure(e)},onSuccess:function(f,g,e){if(this.form&&this.form.template){this.form.template.disabled=true;this.form.template.value=""}if(e){if(!g){this.form.disable()}this.getStatus(f.responseJSON.links[0].href,g)}else{if(g){this.savingBox.replace(this.savedBox)}}document.fire("xwiki:document:saved")},onFailure:function(e){this.savingBox.replace(this.failedBox);this.progressBox.replace(this.failedBox);if(e.statusText==""||e.status==12031){$("ajaxRequestFailureReason").update("Server not responding")}else{if(e.getHeader("Content-Type").match(/^\s*text\/plain/)){$("ajaxRequestFailureReason").update(e.responseText)}else{$("ajaxRequestFailureReason").update(e.statusText)}}document.fire("xwiki:document:saveFailed",{response:e})},startStatusReport:function(e){updateStatus(0)},getStatus:function(g,f,e){new Ajax.Request(g,{method:"get",parameters:{media:"json"},onSuccess:function(i){var h=i.responseJSON.progress.offset;this.updateStatus(h);if(h<1){setTimeout(this.getStatus.bind(this,g,f),1000)}else{this.progressBox.replace(this.savedBox);this.maybeRedirect(f)}}.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bindAsEventListener(this)})},updateStatus:function(e){var g=""+(e*100);var f=g.indexOf(".");if(f>-1){var g=g.substring(0,f+2)}var h=new d.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__",g),"inprogress");this.progressBox.replace(h);this.progressBox=h},maybeRedirect:function(f){var e="";if(!f){e=d.currentDocument.getURL();if(this.form.xredirect&&this.form.xredirect.value){e=this.form.xredirect.value}}else{if($("body").hasClassName("previewbody")){e=d.currentDocument.getURL("edit");if(this.form.xcontinue&&this.form.xcontinue.value){e=this.form.xcontinue.value}}else{return}}if(e){window.location=e}}});function b(){new c.EditActions();new c.AjaxSaveAndContinue();return true}(d.domIsLoaded&&b())||document.observe("xwiki:dom:loaded",b);function a(){if(typeof(Wysiwyg)=="undefined"){return}var h=Wysiwyg.getInstances();for(var f in h){var g=h[f];var e=g.getPlainTextArea();if(e&&!e.disabled){$(f).value=e.value}else{g.getCommandManager().execute("submit")}}}document.observe("xwiki:actions:save",a);document.observe("xwiki:actions:preview",a);return d}(XWiki||{}));