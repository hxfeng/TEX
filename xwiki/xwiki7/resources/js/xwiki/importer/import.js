var XWiki=(function(d){var c=d.importer=d.importer||{};var b={availableDocuments:"$services.localization.render('core.importer.availableDocuments')",importHistoryLabel:"$services.localization.render('core.importer.importHistory')",selectionEmpty:"$services.localization.render('core.importer.selectionEmptyWarning')","import":"$services.localization.render('core.importer.import')","package":"$services.localization.render('core.importer.package')",description:"$services.localization.render('core.importer.package.description')",version:"$services.localization.render('core.importer.package.version')",licence:"$services.localization.render('core.importer.package.licence')",author:"$services.localization.render('core.importer.package.author')",documentSelected:"$services.localization.render('core.importer.documentSelected')",whenDocumentAlreadyExists:"$services.localization.render('core.importer.whenDocumentAlreadyExists')",addNewVersion:"$services.localization.render('core.importer.addNewVersion')",replaceDocumentHistory:"$services.localization.render('core.importer.replaceDocumentHistory')",resetHistory:"$services.localization.render('core.importer.resetHistory')",importAsBackup:"$services.localization.render('core.importer.importAsBackup')",select:"$services.localization.render('core.importer.select')",all:"$services.localization.render('core.importer.selectAll')",none:"$services.localization.render('core.importer.selectNone')"};var a=function(){$$("#packagelistcontainer a.package").invoke("observe","click",function(g){var e=g.element(),f=e.href.substring(e.href.indexOf("&file=")+6);g.stop();$$("div#packagelistcontainer div.active").invoke("removeClassName","active");g.element().up("div.package").addClassName("active");new c.PackageExplorer("packagecontainer",decodeURIComponent(f))});$$("#packagelistcontainer .deletelink").invoke("observe","click",function(e){e.stop();new d.widgets.ConfirmedAjaxRequest(e.findElement("a").href,{onSuccess:function(){if(e.element().up("div.active")){$("packagecontainer").update()}e.findElement("li").remove()}},{confirmationText:"$services.localization.render('core.viewers.attachments.delete.confirm')"})})};if(!browser.isIE6x){document.observe("xwiki:dom:loaded",function(){a();var f=$("AddAttachment");if(f&&typeof(d.FileUploader)!="undefined"){var e=new d.FileUploader(f.down("input[type='file']"),{progressAutohide:true,responseContainer:$("packagelistcontainer"),responseURL:window.docgeturl+"?xpage=packagelist&forceTestRights=1"});f.observe("xwiki:html5upload:done",a);e.hideFormButtons()}})}Element.addMethods("input",{uncheck:function(e){e=$(e);e.checked=false;return e},check:function(e){e=$(e);e.checked=true;return e}});c.PackageInformationRequest=Class.create({initialize:function(h,g){this.name=h;this.successCallback=g.onSuccess||function(){};this.failureCallback=g.onFailure||function(){};var f=window.docgeturl+"?xpage=packagedescriptor&package="+encodeURIComponent(h);var e=new Ajax.Request(f,{onSuccess:this.onSuccess.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})},on1223:function(e){e.request.options.onSuccess(e)},on0:function(e){e.request.options.onFailure(e)},onSuccess:function(e){this.successCallback(e)},onFailure:function(e){this.failureCallback(e)}});c.PackageExplorer=Class.create({initialize:function(g,f){this.node=$(g);this.name=f;this.ignore={};this.documentCount={};this.node.addClassName("loading");var e=new c.PackageInformationRequest(f,{onSuccess:this.onPackageInfosAvailable.bind(this),onFailure:this.onPackageInfosRequestFailed.bind(this)})},onPackageInfosAvailable:function(g){var e=g.responseText.evalJSON();this.infos=e.infos;this.entities=d.EntityReferenceTree.fromJSONObject(e.entities);(function f(h){var i=document.createElement("link");i.type="text/css";i.rel="stylesheet";i.href=h;document.getElementsByTagName("head")[0].appendChild(i)})("$services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'tree.min.css', {'evaluate': true})");require(["$!services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'require-config.min.js', {'evaluate': true})"],this.requireTree.bind(this))},requireTree:function(){require(["tree"],this.initXTree.bind(this))},initXTree:function(g){this.node.removeClassName("loading");this.node.update();if(this.node.empty()){this.node.insert(new Element("h4",{"class":"legend"}).update(b.availableDocuments))}this.container=new Element("div",{id:"packageDescription"});this.node.insert(this.container);this.container.insert(this.createPackageHeader(this.infos));var e=new Element("span").update(b.none);e.observe("click",this.onIgnoreAllDocuments.bind(this));var f=new Element("span").update(b.all);f.observe("click",this.onRestoreAllDocuments.bind(this));this.container.insert(new Element("div",{"class":"selectLinks"}).insert(b.select).insert(e).insert(", ").insert(f));this.list=new Element("ul");this.container.insert(new Element("div",{id:"package","class":"package xtree jstree-no-links"}).update(this.list));Object.values(this.entities.children).each(this.addSpace.bind(this));this.container.insert(this.createPackageFormSubmit(this.infos));this.container.down("div.packagesubmit input[type=radio]").checked=true;g("#package").xtree({plugins:["checkbox"]});this.xtree=g.jstree.reference(g("#package"));this.xtree.check_all()},onIgnoreAllDocuments:function(){this.xtree.uncheck_all()},onRestoreAllDocuments:function(){this.xtree.check_all()},onPackageInfosRequestFailed:function(f){this.node.update();var e="Failed to retrieve package information. Reason: ";if(f.statusText==""||response.status==12031){e+="Server not responding"}else{e+=f.statusText}this.node.removeClassName("loading");this.node.update(new Element("div",{"class":"errormessage"}).update(e))},createPackageFormSubmit:function(j){var i=new Element("div",{"class":"packagesubmit"});i.insert(new Element("div").update(b.whenDocumentAlreadyExists));var g=new Element("input",{type:"radio",name:"historyStrategy",checked:"checked",value:"add"});i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(g).insert(b.addNewVersion));i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"replace"})).insert(b.replaceDocumentHistory));i.insert(new Element("div",{"class":"historyStrategyOption"}).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"reset"})).insert(b.resetHistory));if(d.hasBackupPackImportRights){var e=new Element("input",{type:"checkbox",name:"importAsBackup",value:"true"});if(j.backup){e.checked=true}i.insert(new Element("div",{"class":"importOption"}).insert(e).insert(b.importAsBackup))}var h=new Element("span",{"class":"buttonwrapper"});var f=new Element("input",{type:"submit",value:b["import"],"class":"button"});f.observe("click",this.onPackageSubmit.bind(this));h.insert(f);i.insert(h);return i},onPackageSubmit:function(){var h=this.xtree.get_bottom_checked(true);if(h.length==0){var f=new Element("span",{"class":"warningmessage"}).update(b.selectionEmpty);if(!$("packagecontainer").down("div.packagesubmit span.warningmessage")){$("packagecontainer").select("div.packagesubmit input").last().insert({after:f});Element.remove.delay(5,f)}return}var g={};g.action="import";g.name=this.name;g.historyStrategy=$("packageDescription").down("input[type=radio][value='add']").checked?"add":($("packageDescription").down("input[type=radio][value='replace']").checked?"replace":"reset");if(d.hasBackupPackImportRights){g.importAsBackup=$("packageDescription").down("input[type=checkbox][name='importAsBackup']").checked?"true":"false"}g.ajax="1";var e=[];h.each(function(j){var i=j.data.reference+":"+j.data.locale;e.push(i);g["language_"+i]=j.data.locale});g.pages=e;this.node.update();this.node.addClassName("loading");this.node.setStyle("min-height:200px");new Ajax.Request(window.location,{method:"post",parameters:g,onSuccess:function(i){$("packagecontainer").removeClassName("loading");$("packagecontainer").update(i.responseText)},onFailure:function(j){var i="Failed to import documents. Reason: ";if(j.statusText==""||j.status==12031){i+="Server not responding"}else{i+=j.statusText}$("packagecontainer").removeClassName("loading");$("packagecontainer").update(new Element("div",{"class":"errormessage"}).update(i))}})},createPackageHeader:function(f){var e=new Element("div",{"class":"packageinfos"});e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b["package"])).insert(new Element("span",{"class":"filename"}).update(this.name)));if(f.name!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.description)).insert(new Element("span",{"class":"name"}).update(f.name)))}if(f.version!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.version)).insert(new Element("span",{"class":"version"}).update(f.version)))}if(f.author!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.author)).insert(new Element("span",{"class":"author"}).update(f.author)))}if(f.licence!==""){e.insert(new Element("div").insert(new Element("span",{"class":"label"}).update(b.licence)).insert(new Element("span",{"class":"licence"}).update(f.licence)))}return e},addSpace:function(e){this.addSpaceToList(this.list,e[d.EntityType.SPACE])},addSpaceToList:function(e,h){var g=new Element("li",{"data-type":"space","data-reference":h.reference,"data-jstree":'{"icon":"fa fa-folder-o","iconOpened":"fa fa-folder-open-o"}'}).update(h.reference.name);var i=new Element("ul");var f=this;Object.values(h.children).each(function(j){if(j.hasOwnProperty(d.EntityType.SPACE)){f.addSpaceToList(i,j[d.EntityType.SPACE])}if(j.hasOwnProperty(d.EntityType.DOCUMENT)){f.addDocumentToList(i,j[d.EntityType.DOCUMENT])}});g.insert(i);e.insert(g)},addDocumentToList:function(f,e){Object.values(e.locales).each(function(i){var g=i.name;if(i.locale!=""){g+=" - "+i.locale}var h=new Element("li",{"data-type":"document","data-reference":i,"data-locale":i.locale,"data-jstree":'{"icon":"fa fa-file-o"}'}).update(g);f.insert(h)})},});return d})(XWiki||{});