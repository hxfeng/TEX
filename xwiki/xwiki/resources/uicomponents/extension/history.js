require(["jquery","xwiki-events-bridge"],function(e){e(".extension-history-sources-header").click(function(){e(this).closest(".extension-history-sources-selector").toggleClass("opened")});e(".extension-history-sources-selector").removeClass("opened");var i=function(s){s.preventDefault();var r=e(this);if(!window.confirm(r.attr("data-confirmation"))){return}r.addClass("loading").children().hide();var t=r.attr("href").replace(/xredirect=/,"xfoo=");e.get(t).done(function(){var u=r.closest(".extension-history-source");if(u.hasClass("selected")){var v=u.parent().children().first();g.call(v.children(".extension-history-source-name"))}u.remove()}).fail(function(){r.removeClass("loading").children().show()})};var g=function(t){t&&t.preventDefault();var u=e(this).closest(".extension-history-source");if(u.hasClass("selected")){return}u.parent().children(".selected").removeClass("selected");u.addClass("selected");var s=u.closest(".extension-history-sources-selector");s.removeClass("opened").find(".extension-history-sources-header em").text(e(this).text());var r=s.next(".extension-history-records-form");r.find(".extension-history-record").hide();r.find(".extension-history-actions").hide();r.children(".extension-history-records").append('<li class="extension-history-record loading"><span style="visibility:hidden">Loading</span></li>');e.get(u.attr("data-recordsURL")).done(function(v){r.replaceWith(v);r=s.next(".extension-history-records-form");r.size()>0&&e(document).trigger("xwiki:dom:updated",{elements:r.toArray()})}).fail(function(){})};var m=function(r){r.find(".extension-history-source a.deleteLink").click(i);r.find("a.extension-history-source-name").click(g)};m(e(".extension-history-sources"));var k=function(u,t){if(t.type==="done"){var r=e(u.target).closest(".extension-history-sources-body");m(r);var s=t.parameters.name;var v=r.find(".extension-history-source").filter(function(){return e(this).attr("data-fileName")===s}).first();g.call(v.find(".extension-history-source-name"))}};if(typeof(XWiki.FileUploader)!="undefined"){e('.extension-history-source-upload input[type="file"]').each(function(){e(this).on("xwiki:html5upload:message",k);new XWiki.FileUploader(this,{maxFilesize:1000000,fileFilter:/application\/xml|text\/xml/i,progressAutohide:true,responseContainer:e(".extension-history-sources")[0]})})}var c=function(s){s.preventDefault();var t=e(s.target).css("visibility","hidden");var r=t.closest(".extension-history-record").addClass("loading");e.get(t.attr("href")).done(function(v){var u=e(document.createElement("div"));var w=u.append(v).find(".extension-history-record");e(document).trigger("xwiki:dom:updated",{elements:u.toArray()});r.replaceWith(w)}).fail(function(){r.removeClass("loading");t.css("visibility",null)})};var j=function(){var r=e(this).closest(".extension-history-records-form");var s=r.find('input[name="extensionHistoryRecord"]:checked').length;r.find("button").prop("disabled",s==0)};var l=function(r){r.find(".extension-history-record a.more").click(c);j.call(r);r.find('.extension-history-record input[type="checkbox"]').click(j)};l(e(".extension-history-records-form"));e(document).on("xwiki:dom:updated",function(r,s){l(e(s.elements))});var b=function(t){t.preventDefault();var s=e(t.target).closest(".extension-history");var r=s.find(".extension-history-replay-options");if(r.length>0){r.removeClass("hidden").prevAll().hide();r.get(0).scrollIntoView()}else{o(s)}};e('.extension-history-actions button[value="replayPlan"]').click(b);e(document).on("xwiki:dom:updated",function(r,s){e(s.elements).find('.extension-history-actions button[value="replayPlan"]').click(b)});e('.extension-history-replay-options button[value="replayPlan"]').click(function(r){r.preventDefault();o(e(r.target).closest(".extension-history"))});e(".extension-history-replay-options a.btn-default").click(function(r){r.preventDefault();d&&d.abort();e(r.target).closest(".extension-history-replay-options").addClass("hidden").prevAll().show()});var p=function(r){r.find("a.btn-default").click(q);r.find('button[value="replay"]').click(a)};var d;var o=function(s){var r=s.children("form");var t=r.serialize()+"&data=replayPlan";r.find(":input").prop("disabled",true);d=e.post(r.attr("action"),t).always(function(){r.find(":input").prop("disabled",false)}).done(function(u){s.children().hide();s.find(".extension-history-replay-options").show().addClass("hidden");s.append(u);var v=s.find(".extension-history-replay-plan");v.size()>0&&e(document).trigger("xwiki:dom:updated",{elements:v.toArray()});p(v)}).fail(function(){})};var q=function(s){s.preventDefault();var r=e(s.target).closest(".extension-history");r.children(".extension-history-replay-plan").remove();r.children().show()};var a=function(s){s.preventDefault();var u=e(this).prop("disabled",true);var r=u.closest("form");var t=r.serialize()+"&action=replay";e.post(r.attr("action"),t).done(function(w){var v=window.location.href.replace(/#.*$/,"");v+=v.indexOf("?")<0?"?":"&";window.location=v+e.param({data:"replayStatus",jobId:w.jobId})}).fail(function(){u.prop("disabled",false)})};var n=function(r,u){u=u||{};var s=f(r);if(!!u.logOpened!==s.logOpened){r.find(".extension-history-replay-log .collapse-toggle").click()}var t=r.attr("data-jobState");if(t=="WAITING"){r.find('form.extension-question button[value="continue"]').click(e.proxy(h,null,r,"action=continue"));r.find('form.extension-question button[name="extensionAction"]').click(e.proxy(h,null,r,"data=replayStatus"))}else{if(typeof t=="string"&&t!="FINISHED"){setTimeout(e.proxy(h,this,r),1000)}}};var f=function(r){return{logOpened:r.find(".log.hidden").size()===0}};var h=function(r,t,s){if(s){s.preventDefault();t+="&"+e(this).closest("form").serialize()}else{t=t||{data:"replayStatus",jobId:r.attr("data-jobId")}}e.post(r.attr("data-extensionHistoryURL"),t).done(function(v){var w=f(r);var x=e(document.createElement("div"));x.append(v);n(x.find(".extension-history-replay-status"),w);var u=x.children();r.replaceWith(u);e(document).trigger("xwiki:dom:updated",{elements:u.toArray()})}).fail(function(){})};n(e(".extension-history-replay-status"))});