var XWiki=(function(o){var v=0;o.EntityType={WIKI:v++,SPACE:v++,DOCUMENT:v++,ATTACHMENT:v++,OBJECT:v++,OBJECT_PROPERTY:v++,CLASS_PROPERTY:v++};var d=[];for(var t in o.EntityType){if(o.EntityType.hasOwnProperty(t)){var f=o.EntityType[t];var s=t.toLowerCase().split("_");for(var x=1;x<s.length;x++){s[x]=s[x].substr(0,1).toUpperCase()+s[x].substr(1)}d[f]=s.join("")}}o.EntityType.getName=function(i){return d[i]};o.EntityType.byName=function(E){var i=E.toLowerCase();for(var D=0;D<d.length;D++){if(d[D]===i){return D}}return -1};o.EntityReference=Class.create({initialize:function(D,F,E,i){this.name=D;this.type=F;this.parent=E;this.locale=i},extractReference:function(D){var i=this;while(i&&i.type!=D){i=i.parent}return i},extractReferenceValue:function(D){var i=this.extractReference(D);return i?i.name:null},relativeTo:function(G){var F=this.getReversedReferenceChain();var H=G?G.getReversedReferenceChain():[];var E=j=0;while(E<F.length&&j<H.length&&F[E].type!=H[j].type){F[E].type>H[j].type?j++:E++}while(E<F.length&&j<H.length&&F[E].type===H[j].type&&F[E].name===H[j].name){E++;j++}if(j<H.length&&j>0&&H[j].type===H[j-1].type&&E>0){for(E--;E>0&&F[E].type===F[E-1].type;E--){}}var D;for(;E<F.length;E++){D=new o.EntityReference(F[E].name,F[E].type,D)}return D||new o.EntityReference("",this.type)},getReversedReferenceChain:function(){var D=[];var i=this;while(i){D.push(i);i=i.parent}return D.reverse()},getRoot:function(){var i=this;while(i.parent){i=i.parent}return i},appendParent:function(i){this.getRoot().parent=i;return this},equals:function(i){if(i==null){return false}if((this.parent==null&&i.parent!=null)||(this.parent!=null&&i.parent==null)){return false}return this.name===i.name&&this.type===i.type&&(this.parent==null||this.parent.equals(i.parent))},toString:function(){return o.Model.serialize(this)},getName:function(){return this.name}});o.EntityReference.fromJSONObject=function(i){var D;if(i.parent!=null){D=o.EntityReference.fromJSONObject(i.parent)}else{D=undefined}return new o.EntityReference(i.name,o.EntityType.byName(i.type),D,i.locale)};o.WikiReference=Class.create(o.EntityReference,{initialize:function($super,i){$super(i,o.EntityType.WIKI)}});o.SpaceReference=Class.create(o.EntityReference,{initialize:function($super,H,E){var F=new o.WikiReference(H);if(Array.isArray(E)&&E.length>0){var D=F;var G;for(G=0;G<E.length-1;++G){D=new o.EntityReference(E[G],o.EntityType.SPACE,D)}$super(E[G],o.EntityType.SPACE,D)}else{if(typeof E==="string"||typeof E=="undefined"){$super(E,o.EntityType.SPACE,F)}else{throw"Missing mandatory space name or invalid type for: ["+E+"]"}}}});o.DocumentReference=Class.create(o.EntityReference,{initialize:function($super,E,D,i){$super(i,o.EntityType.DOCUMENT,new o.SpaceReference(E,D))}});o.AttachmentReference=Class.create(o.EntityReference,{initialize:function($super,D,i){$super(D,o.EntityType.ATTACHMENT,i)}});o.EntityReferenceTreeNode=Class.create({initialize:function(){this.children={};this.locales={}},_fromJSONObject:function(i){if(i.reference!=null){this.reference=o.EntityReference.fromJSONObject(i.reference)}i.children.each(this._childFromJSONObject.bind(this));i.locales.each(this._localeFromJSONObject.bind(this))},_childFromJSONObject:function(i){var D=new o.EntityReferenceTreeNode();D._fromJSONObject(i);var E=this.children[D.reference.name];if(typeof E=="undefined"){E={};this.children[D.reference.name]=E}E[D.reference.type]=D},_localeFromJSONObject:function(i){this.locales[i.locale]=o.EntityReference.fromJSONObject(i)},hasChildren:function(){return Object.keys(this.children).length!==0},hasLocales:function(){return Object.keys(this.locales).length!==0},getChildByReference:function(D){if(typeof D=="undefined"){return null}var H=this;var G=D.getReversedReferenceChain();for(var F=0;F<G.length;F++){var E=G[F];var I=H.children[E.name];if(typeof I=="undefined"){return null}H=I[E.type];if(typeof H=="undefined"){return null}}return H}});o.EntityReferenceTree=Class.create(o.EntityReferenceTreeNode,{});o.EntityReferenceTree.fromJSONObject=function(D){var i=new o.EntityReferenceTree();i._fromJSONObject(D);return i};var u="\\";var m=u+u;var p=":";var A=".";var h="@";var b="^";var B=A;var r=b;var q=[[],[A,p,u],[A,u],[h,u],[b,u],[B,u],[r,A,u]];var w=[[],[u+A,u+p,m],[u+A,m],[u+h,m],[u+b,m],[u+B,m],[u+r,u+A,m]];var y=[[],[A,p],[A,p],[h,A,p],[b,A,p],[B,b,A,p],[r,A,p]];var n=[null,o.EntityType.WIKI,o.EntityType.SPACE,o.EntityType.DOCUMENT,o.EntityType.DOCUMENT,o.EntityType.OBJECT,o.EntityType.DOCUMENT];var l=[];for(var x=1;x<y.length;x++){l[x]={}}l[o.EntityType.SPACE][p]=o.EntityType.WIKI;l[o.EntityType.SPACE][A]=o.EntityType.SPACE;l[o.EntityType.DOCUMENT][A]=o.EntityType.SPACE;l[o.EntityType.ATTACHMENT][h]=o.EntityType.DOCUMENT;l[o.EntityType.OBJECT][b]=o.EntityType.DOCUMENT;l[o.EntityType.OBJECT_PROPERTY][B]=o.EntityType.OBJECT;l[o.EntityType.CLASS_PROPERTY][r]=o.EntityType.DOCUMENT;var c=[[o.EntityType.WIKI],[o.EntityType.SPACE,o.EntityType.WIKI],[o.EntityType.DOCUMENT,o.EntityType.SPACE,o.EntityType.WIKI],[o.EntityType.ATTACHMENT,o.EntityType.DOCUMENT,o.EntityType.SPACE,o.EntityType.WIKI],[o.EntityType.OBJECT,o.EntityType.DOCUMENT,o.EntityType.SPACE,o.EntityType.WIKI],[o.EntityType.OBJECT_PROPERTY,o.EntityType.OBJECT,o.EntityType.DOCUMENT,o.EntityType.SPACE,o.EntityType.WIKI],[o.EntityType.CLASS_PROPERTY,o.EntityType.DOCUMENT,o.EntityType.SPACE,o.EntityType.WIKI]];var C=[m,u];var e=[u,""];function k(H,D,E){for(var G=0;G<E.length;G++){var F=D+G;if(F>=H.length||H.charAt(F)!=E.charAt(G)){return false}}return true}function a(H,G,F){var E=-1;while(++E<H.length){for(var D=0;D<G.length;D++){if(k(H,E,G[D])){H=H.substr(0,E)+F[D]+H.substr(E+G[D].length);E+=F[D].length-1;break}}}return H}o.EntityReferenceResolver=Class.create({resolve:function(O,L,E){var F=(O||"").split("");L=parseInt(L);if(isNaN(L)||L<0||L>=y.length){throw"No parsing definition found for Entity Type ["+L+"]"}var H=l[L];if(!H){return this._getEscapedReference(F,L,E)}var G,K=L;do{var Q=null;var I=F.length;while(--I>=0){var R=F[I];var J=I-1;var D=J<0?0:F[J];if(typeof H[R]==="number"){var P=this._getNumberOfCharsBefore(u,F,J);if(P%2===0){Q=H[R];break}else{F.splice(J,1);--I}}else{if(D===u){F.splice(J,1);--I}}}var N=this._getNewReference(I,F,K,E);G=this._appendNewReference(G,N);K=Q?Q:n[K];H=l[K]}while(H!=null);var M=this._getEscapedReference(F,K,E);G=this._appendNewReference(G,M);return G},_getEscapedReference:function(D,E,F){if(D.length>0){var i=a(D.join(""),C,e);return new o.EntityReference(i,E)}else{return this._resolveDefaultReference(E,F)}},_getNewReference:function(F,E,G,H){var i;if(F<E.length-1){var D=E.slice(F+1).join("");i=new o.EntityReference(D,G)}else{i=this._resolveDefaultReference(G,H)}E.splice(Math.max(F,0),E.length);return i},_resolveDefaultReference:function(G,H){var E,D;if(typeof H==="object"){if(H&&typeof H.extractReference==="function"){D=H.extractReference(G);E=[];while(D&&D.type===G){E.push(D.name);D=D.parent}E.reverse()}else{E=H&&H[G]}}else{if(typeof H==="function"){E=H(G)}}D=null;if(E&&E.length>0){if(typeof E==="string"){E=[E]}for(var F=0;F<E.length;F++){D=new o.EntityReference(E[F],G,D)}}return D},_appendNewReference:function(i,D){if(D){if(i){return i.appendParent(D)}else{return D}}else{return i}},_getNumberOfCharsBefore:function(F,D,E){var i=E;while(i>=0&&D[i]===F){--i}return E-i}});o.EntityReferenceSerializer=Class.create({serialize:function(i){return i?this.serialize(i.parent)+this._serializeComponent(i):""},_serializeComponent:function(E){var i="";var D=q[E.type];if(E.parent){i+=E.parent.type===o.EntityType.WIKI?p:D[0]}if(D.length>0){i+=a(E.name,D,w[E.type])}else{i+=E.name.replace(u,m)}return i}});var g=new o.EntityReferenceResolver();var z=new o.EntityReferenceSerializer();o.Model={serialize:function(i){return z.serialize(i)},resolve:function(i,D,E){return g.resolve(i,D,E)}};return o}(XWiki||{}));